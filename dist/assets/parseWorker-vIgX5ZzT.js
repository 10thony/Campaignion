function x(c,a,h){self.postMessage({type:"progress",stage:c,page:a,totalPages:h})}self.onmessage=async c=>{if(!(!c.data||c.data.type!=="parse"))try{x("loading pdf");const a=await import("./pdf-CHhNo-mi.js"),h=(await import("./pdf.worker.min-B8sd9tUL.js")).default;try{a.GlobalWorkerOptions.workerSrc=h}catch{}const i=await a.getDocument({data:c.data.fileBuffer,verbosity:0}).promise,y=[];let k="";for(let o=1;o<=i.numPages;o++){x("extracting text",o,i.numPages);try{const u=(await(await i.getPage(o)).getTextContent()).items.filter(t=>typeof t.str=="string"&&t.str.trim()).map(t=>({str:t.str,x:Math.round(t.transform[4]),y:Math.round(t.transform[5]),width:t.width,height:t.height})),n=new Map;for(const t of u){const e=Math.round(t.y/2)*2;n.has(e)||n.set(e,[]),n.get(e).push(t)}const w=Array.from(n.keys()).sort((t,e)=>e-t).map(t=>{const e=n.get(t);return e.sort((g,l)=>g.x-l.x),{y:t,items:e,text:e.map(g=>g.str).join(" ")}}),d=w.map(t=>t.text).join(`
`);y.push({pageNumber:o,lines:w,rawText:d}),k+=d+`
`}catch{}}if(!k.trim()&&c.data.ocrAllowed)for(let o=1;o<=i.numPages;o++){x("ocr",o,i.numPages);const m=await i.getPage(o),f=m.getViewport({scale:2}),u=new OffscreenCanvas(f.width,f.height),n=u.getContext("2d");await m.render({canvasContext:n,viewport:f}).promise;const M=await u.convertToBlob({type:"image/png"}),{recognizeImageBlob:w}=await import("./ocr-CdIoAP0_.js"),d=await w(M),t=[],e=new Map;for(const s of d.words){const r=Math.round((s.y0+s.y1)/2/2)*2;e.has(r)||e.set(r,[]),e.get(r).push({x:Math.round((s.x0+s.x1)/2),str:s.text})}const g=Array.from(e.keys()).sort((s,r)=>r-s);for(const s of g){const r=e.get(s);r.sort((p,T)=>p.x-T.x);const C=r.map(p=>p.str).join(" ");t.push({y:s,items:r.map(p=>({str:p.str,x:p.x,y:s})),text:C})}const l=t.map(s=>s.text).join(`
`);y.push({pageNumber:o,lines:t,rawText:l}),k+=l+`
`}x("extracting sections");const{extractCharacterDataFromStructuredPages:b}=await import("./publicExtraction-CQrNJhrV.js"),P=b(y);self.postMessage({type:"result",ok:!0,parsed:P})}catch(a){self.postMessage({type:"result",ok:!1,error:(a==null?void 0:a.message)||"Unknown error"})}};
